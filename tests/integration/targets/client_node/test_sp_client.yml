---
# Playbook for IBM Storage Protect Clients and Server..

# Step 1: Add dsm.sys file to clients
- name: Add dsm.sys file to clients
  hosts: 10.240.64.8 # Dynamic client hosts passed via extra vars
  gather_facts: false
  tasks:
    - name: Validate required variables for clients
      ansible.builtin.debug:
        msg:
          - "Server Name: {{ storage_protect_server_name }}"
          - "Server IP: {{ storage_protect_server_ip }}"

    - name: Check TIVsm RPMs are installed
      ansible.builtin.command:
        cmd: rpm -qa | grep -i tivsm
      changed_when: false

    - name: Check required files exist
      ansible.builtin.stat:
        path: "/opt/tivoli/tsm/client/ba/bin/{{ item }}"
      loop:
        - dsmc
        - dsm.opt
      register: required_files
      failed_when: not required_files.stat.exists

    - name: Create dsm.sys
      ibm.storage_protect.dsm_sysfile:
        server_name: "ansible-ibm-sp-host05"
        tcp_server_address: "10.240.64.6"

# Step 2: Test register server in IBM Storage Protect
- name: Test register server in IBM Storage Protect
  hosts: "10.240.64.6"  # Dynamic server host passed via extra vars
  gather_facts: false
  vars:
    storage_protect_nodes:
      - name: "10.240.64.8"
        policy_domain: "{{ client_policy_domain }}"
        node_password: "{{ client_password }}"
        session_security: strict
        node_password_expiry: 90
        can_archive_delete: true
        min_extent_size: 250
        replication_state: enabled
        backup_repl_rule_default: NONE

  pre_tasks:
    - name: Validate required variables for server
      ansible.builtin.debug:
        msg:
          - "Server Name: {{ storage_protect_server_name }}"
          - "Server IP: {{ ansible_host }}"
          - "Username: {{ storage_protect_username }}"

    - name: Create dsm.sys
      ibm.storage_protect.dsm_sysfile:
        server_name: "10.240.64.6"
        tcp_server_address: "ansible-ibm-sp-host05"

  roles:
    - ibm.storage_protect.nodes
...
